#!/bin/bash
#Register
subscription-manager register "--username=<%= rh_username %>" "--password=<%= rh_password %>" --autosubscribe

#Attach to RHOS product
poolid="$(subscription-manager list --available | grep -A2 "Red Hat OpenStack" | tail -1 | cut -f2)" 
subscription-manager attach "--pool=$poolid"

#Enable channels
for channel in <%= rh_channels %>; do
  yum-config-manager --enable "$channel"
done
 
#Tell RHSM to let CentOS accept packages from Red Hat

#Generate /etc/yum.repos.d/redhat.repo
yum --releasever=<%= releasever %> repolist || :

<% if use_satellite %>
#Save centos-release RPM so it can be reinstalled later
mkdir -p /root/centos-release
yumdownloader --destdir /root/centos-release --disablerepo='*rhel*' /root/centos-release/
if ! [ -f /root/centos-release/centos-release*.rpm ];then
  echo "Unable to download centos-release RPM. Aborting."
  exit 1
fi
#Download RHN packages needed for RHN Satellite registration
rhnpackages="m2crypto rhn-check rhn-client-tools rhnlib rhnsd rhn-setup yum-rhn-plugin redhat-release-sever"
mkdir -p /root/rhnpackages
yum-config-manager --enable rhel-6-server-rpms
yumdownloader --releasever=<%= releasever %> --disablerepo='*' --enablerepo='*rhel*' --resolve --destdir /root/rhnpackages $rhnpackages
rpm -ivh --force /root/rhnpackages/*.rpm


#Download RHN Satellite GPG key
mkdir -p /etc/sysconfig/rhn
wget "<%= sat_hostname %>/pub/RHN-ORG-TRUSTED-SSL-CERT" -O /etc/sysconfig/rhn/RHNS-CA-CERT
if [ "$(file -b /etc/sysconfig/rhn/RHNS-CA-CERT)" != "PGP public key block" ];then
  echo "GPG Key download failed. Looking for URL <%= sat_hostname %>/pub/RHN-ORG-TRUSTED-SSL-CERT. Cannot proceed"
  exit 1
fi

#Disable subscription-manager
subscription-manager unregister
rm -rf /etc/yum.repos.d/redhat.repo

#Run registration
rhnreg_ks "--serverUrl=http://<%= sat_hostname %>/XMLRPC" --profilename=fuelweb "--activation-key=<%= activation_key %>" --sslCACert=/etc/sysconfig/rhn/RHNS-CA-CERT --nopackages --nohardware --novirtinfo --norhnsd --force

if [ $? -ne 0 ];then
  echo "Registration failed. Aborting."
  exit 1
fi


<% end %>

#Download packages
mkdir -p /var/www/nailgun/rhel/6.4/nailgun/x86_64/repodata
yumdownloader --releasever=<%= releasever %> --disablerepo='*' --enablerepo='rhel*' --resolve --destdir /var/www/nailgun/rhel/6.4/nailgun/x86_64 $(cat /etc/nailgun/required-rpms.txt | xargs echo -en)

#Run again just for good measure
yumdownloader --releasever=<%= releasever %> --disablerepo='*' --enablerepo='rhel*' --resolve --destdir /var/www/nailgun/rhel/6.4/nailgun/x86_64 $(cat /etc/nailgun/required-rpms.txt | xargs echo -en)

#Disable all RHEL repos so you don't accidentally update and break master node
yum-config-manager --disable '*rhel*' > /dev/null


#Need to include RH comps.xml here instead
cp /var/www/nailgun/centos/6.3/nailgun/x86_64/repodata/comps.xml /var/www/nailgun/rhel/6.4/nailgun/x86_64/repodata/comps.xml

createrepo -g /var/www/nailgun/rhel/repodata/comps.xml /var/www/nailgun/rhel


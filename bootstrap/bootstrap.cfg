install
cdrom
lang en_US.UTF-8
keyboard us
network --onboot yes --device eth0 --bootproto dhcp --noipv6
rootpw  r00tme
authconfig --enableshadow --passalgo=sha512
selinux --disabled
timezone --utc Europe/Moscow
bootloader --location=mbr --driveorder=sda --append="crashkernel=auto rhgb quiet"
clearpart --linux --drives=sda
volgroup VolGroup --pesize=4096 pv.008002
logvol / --fstype=ext4 --name=lv_root --vgname=VolGroup --grow --size=1024 --maxsize=51200
logvol swap --name=lv_swap --vgname=VolGroup --grow --size=4032 --maxsize=4032

part /boot --fstype=ext4 --size=500
part pv.008002 --grow --size=1


repo --name="CentOS-6.4"  --baseurl="http://srv11-msk.msk.mirantis.net/centos-repo/centos-6.4/" --cost=100
repo --name="CentOS-6.4-updates" --baseurl="http://srv11-msk.msk.mirantis.net/centos-repo/centos-6.4-updates/" --cost=90
repo --name="epel-fuel-folsom" --baseurl="http://srv11-msk.msk.mirantis.net/centos-repo/epel-fuel-folsom-2.1/" --cost=80
repo --name="fuel-3.0" --baseurl="http://osci-koji.srt.mirantis.net/mash/fuel-3.0/x86_64/" --cost=80 --proxy="http://srv11-msk.msk.mirantis.net:3128"
repo --name="fueliso" --baseurl="http://osci-koji.srt.mirantis.net/mash/fueliso/x86_64/" --cost=80 --proxy="http://srv11-msk.msk.mirantis.net:3128"

%packages --nobase
kernel
lokkit
device-mapper
bash
grub
acl
attr
audit
basesystem
bash
coreutils
cpio
cronie
dhclient
e2fsprogs
efibootmgr
filesystem
glibc
initscripts
iproute
iputils
kbd
openssh-server
passwd
procps
rootfiles
rpm
rsyslog
setup
shadow-utils
sudo
util-linux-ng
vim-minimal
cronie-noanacron
crontabs
dhclient
dmidecode
mcollective
mingetty
net-tools
ntp
openssh-clients
openssh-server
scapy
tcpdump
vconfig
vim-minimal
wget
# ACPI support if is a guest
qemu-guest-agent
nailgun-agent
nailgun-mcagents
nailgun-net-check
bootstrap-files
send2syslog
# Will remove after
system-config-firewall-base
-selinux-policy-targeted
-selinux-policy
-plymouth
-iptables-ipv6
-postfix

# Ruby
rubygem-httpclient
rubygem-ipaddress 
rubygem-json_pure 
rubygem-ohai      
rubygem-rethtool  


%end
%post
rpm -q selinux-policy && rpm -e selinux-policy selinux-policy-targeted
rpm -e system-config-firewall-base
#iptables
cat << EOF > /etc/sysconfig/iptables
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
EOF

#SSH setup
mkdir /root/.ssh
chmod 700 /root/.ssh
cat << EOF > /root/.ssh/id_rsa
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEA7a1U0jPLRneBPJISZ9oHzf9n8pp1/9GCgBklWU1gzSHGC+c1
05UsK3HJ//BIJpzbCTcbnCUU/qFqqwxmhWnobsJWPyAapudCiVWlK+UGMzlKalaR
SKaF91MBEwsXEgdS4kGGwr6yXKjj0OGbvXzITBimgF9aIczrpp+HM7iw2CLwpz56
FOUQ1re4NRmhRZcxlNyRaKI+/2lhSTKiS4p72st769rxaQbztctvZyrvs4KWZM8y
QnNJ3aFarwflvQ2OkLYE0ln3d2RP/L4OIfEFfB/scai/7lgsQ5L9mN674gB4r0f1
ftWAkkB9DQSazUpEY3fta6C4XBBk+/2BJ24FVQIDAQABAoIBAHbFfXOlqllGcvC/
1i7Lh8brcRiNE5aJLfuxlTZxMoSP8hYUrpNTIkV7kYQyoPuauuJ6BXQcG8e7BkD/
62OULzDaMJtPAcKSIm/aurWat2R1prhJFkUF4kBb3FeV3SuHOWYTdLJw9VTUmTPS
6i7g4n8UenAANlxZuREE+11fWBBJPwmcStwGq9qVn+SydLsSxU0g8cGqd+edYV2p
zBINA88iEkEAQzmK8Pmm9Dqbf5trnSGjqe5tkqxV1CEvb3LcIkxlJgMaWoJNF5ip
Ajl/+WD16xEqbSnr9fAkKXdPbZJW9dPckC6gxeiRx2TXl44XXGX6phv/JUzb+b5n
in+lG0ECgYEA+T6CnPKcKnEO+82Kj14vt+UMZADCDN9i42kodwYJSLlQljiAYRhq
/SmjSNV0A77udpKtN/VFkpssRxFiuazOL4IVJyoQnYNRC0Mov6yexYsejmW7B6xd
YPvPkFPShSMXR16l0Qs0K3sE2QvsNHqzF+mOyriCturF/sjQATrBQgkCgYEA9B6O
xdpfudjh+3/Jx03a4SqQ8r5n6hG56SUJi7dfCpt8Sx94vBsoHThog9u132D47OR2
9xyL3kwhbux1IAn3UpvR07pjKlwSsNlIjeU5lrdWqfxwjf9XLI08/yaeJYDzamsF
EkaxGjxFeXXe2W9pZQ8wCH4kC7K5DI3PrOyhi+0CgYEA2tDGWoOkFp6rSOVqf/Nw
cUHlXuZLdoGnj38Cx3vFKtOGrFtuWc/WHewwLgE3mRJGyFJ9QGNUcSFJ/hqFUf0k
BxFtALUtYRuoSvrrC1vBCCza5qjpShNI55wq3cq5R6lHBqFRcfUkGAgoeWS+OlR+
Zr/lXJQgLfZvXP9vnaS3hgECgYBDiUywehivnsvuO01EgUqDrrYJIho3jI3lbWS1
rZZypc9+LQfG6rBvXRK1IAyx7u8PAqnS9afQaTl6qZpBseAlj4w+SjtzFaPqH0LO
VtNW2gP05Szya+jfH3f3kuR/tawiDdeKVdpbSr9hufVcLFF5Lvl38AXi4qAFVBpX
WePbhQKBgQDl0Y0Nzj4zKb+tD3+Cg8/c0xLGqiyKoX+87c9Dru+aWudfZEjrwi2F
Ui3iN31rrEl+OqwJnC4gR+hWuDuF9gVMb17GoiM/fcvgzes9NL1YWFeKHU8ZKRox
w3nxStHyiETfTyC9LOS1JCfFIMcpYD0lFuHnQHib/HX3dmUvbqo77Q==
-----END RSA PRIVATE KEY-----
EOF
cat << EOF > /root/.ssh/id_rsa.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDtrVTSM8tGd4E8khJn2gfN/2fymnX/0YKAGSVZTWDNIcYL5zXTlSwrccn/8EgmnNsJNxucJRT+oWqrDGaFaehuwlY/IBqm50KJVaUr5QYzOUpqVpFIpoX3UwETCxcSB1LiQYbCvrJcqOPQ4Zu9fMhMGKaAX1ohzOumn4czuLDYIvCnPnoU5RDWt7g1GaFFlzGU3JFooj7/aWFJMqJLinvay3vr2vFpBvO1y29nKu+zgpZkzzJCc0ndoVqvB+W9DY6QtgTSWfd3ZE/8vg4h8QV8H+xxqL/uWCxDkv2Y3rviAHivR/V+1YCSQH0NBJrNSkRjd+1roLhcEGT7/YEnbgVV nailgun@bootstrap
EOF
cp /root/.ssh/id_rsa.pub /root/.ssh/authorized_keys2
chmod 600 /root/.ssh/*

#Cleanup
rm -rf /usr/share/locale/[a-df-z]* /usr/share/locale/e[a-mo-z]*
rm -rf /boot/*
rm -rf /home/* /var/cache/yum /var/lib/yum /usr/share/doc/* /usr/src/* /usr/share/man/*
rm -rf /etc/selinux
rm -rf /usr/share/wallpapers /usr/share/backgrounds /usr/share/info 
rm -rf /lib/firmware/{iwl,mts}*
rm -rf /usr/lib/ruby/gems/1.8/cache/*
find /usr/lib64/python2.6 -name '*.pyc' -exec rm -f {} \;
find /usr/lib64/python2.6 -name '*.pyo' -exec rm -f {} \;

#Autorun services
chkconfig exim off
chkconfig setup-bootdev on
%end

